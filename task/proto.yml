# https://taskfile.dev

version: '3'

env:
  BAR: baz

tasks:
  clean:
    desc: Remove generated code.
    cmds:
      - echo "Deleting generated files...."
      - |
        for f in ./mkit/**/**/**/**/*.pb.*; do
          echo ✓ deleting: $f
          rm -f $f
        done
        for f in ./mkit/**/**/**/*.pb.*; do
          echo ✓ deleting: $f
          rm -f $f
        done
#      - task: :clean
    silent: true

  lint:
    desc: Lint protos.
    cmds:
      - echo "Linting proto"
      - buf lint
      - "echo ✓ Proto: Linted"
    silent: true

  breaking:
    desc: Detect breaking proto changes.
    cmds:
      - echo "Checking proto breaking changes"
#      - 'buf  breaking --against ".git#branch=master"'
      - 'buf  breaking --against "{{.GIT_REPO_URL}}#branch=master"'
      - "echo ✓ Proto: Breaking"
#    silent: true

  format:
    desc: Format protos.
    cmds:
      - echo "Formatting protos"
#      - '{{.GOPATH}}/bin/prototool format -w proto'
      - "echo ✓ Proto: Formatted"
    silent: true

  check:
    desc: Check protos.
    deps: [lint, breaking]
    cmds:
      - task: format

  generate:
    desc: Generate code from protos.
    cmds:
      - echo "Generating code"
      - 'buf generate --path {{.PROTO_IN}}'
    sources:
      - '{{.PROTO_IN}}/**/*.proto'
    generates:
      - '{{.PROTO_OUT}}/**/*.pb.*'

  default:
    desc: Do all protos.
    cmds:
      - task: check
      - task: clean
      - task: generate
      - "echo ✓ Proto: All done"
    silent: true
    sources:
      - '{{.PROTO_IN}}/**/*.proto'
    generates:
      - '{{.PROTO_OUT}}/**/*.pb.*'
